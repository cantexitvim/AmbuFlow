<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediChat - Your Medical Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
      body {
        font-family: 'Arial', sans-serif;
        background-color: #f0f4f8;
      }
      .chat-container {
        max-width: 800px;
        height: 80vh;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .chat-messages {
        height: calc(100% - 120px);
        overflow-y: auto;
        padding: 20px;
      }
      .message {
        max-width: 80%;
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 18px;
        line-height: 1.4;
        font-weight: 500;
      }
      .user-message {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 0;
      }
      .ai-message {
        background-color: #e9ecef;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 0;
      }
      .input-area {
        border-top: 1px solid #e0e0e0;
        padding: 10px;
        background-color: #ffffff;
      }
      .input-area form {
        display: flex;
        flex-direction: column;
      }
      .input-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .input-area input[type="text"] {
        flex-grow: 1;
        border: none;
        outline: none;
        padding: 10px;
        border-radius: 20px;
        background-color: #f0f4f8;
      }
      .input-area button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-left: 10px;
      }
      .input-area button:hover {
        background-color: #0056b3;
      }
      .loading-dots {
        display: inline-flex;
        align-items: center;
      }
      .loading-dots div {
        width: 8px;
        height: 8px;
        background-color: #007bff;
        border-radius: 50%;
        margin: 0 3px;
        animation: bounce 0.6s infinite alternate;
      }
      .loading-dots div:nth-child(2) {
        animation-delay: 0.2s;
      }
      .loading-dots div:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes bounce {
        to {
          transform: translateY(-4px);
        }
      }
      .image-preview {
        max-width: 40px;
        max-height: 40px;
        object-fit: cover;
        border-radius: 50%;
        margin-right: 10px;
      }
      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
      }
      .file-input-wrapper input[type=file] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
      }
      .file-input-wrapper .btn-file-input {
        background-color: #28a745;
        color: white;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen p-4">
    <div class="chat-container w-full flex flex-col">
      <div class="chat-header bg-blue-600 text-white p-4 rounded-t-lg flex items-center">
        <i class="fas fa-robot text-2xl mr-3"></i>
        <h1 class="text-xl font-bold">MediChat - Your Medical Assistant</h1>
      </div>
      <div id="chat-messages" class="chat-messages flex flex-col">
        <div class="message ai-message">
          Hello! I'm MediChat, your virtual medical assistant. How can I help you today? You can also upload an image if you have a visual medical question.
        </div>
      </div>
      <div class="input-area mt-auto" style="margin-bottom: 10px;">
        <form id="chat-form" class="flex flex-col">
          <div class="input-row">
            <div class="file-input-wrapper mr-2">
              <button class="btn-file-input" type="button">
                <i class="fas fa-image"></i>
              </button>
              <input type="file" id="image-input" accept="image/*">
            </div>
            <img id="image-preview" class="image-preview" style="display: none;">
            <input type="text" id="user-input" class="flex-grow" placeholder="Type your medical question here...">
            <button type="submit" id="send-btn" aria-label="Send message">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script type="module">
      import { GoogleGenerativeAI, HarmBlockThreshold, HarmCategory } from "@google/generative-ai";

      const API_KEY = "AIzaSyBF265bY6o63VuPypal-5w0-b7sr0N_O3A"; // Replace with your gemini-api actual API key
      const genAI = new GoogleGenerativeAI(API_KEY);
      let chat;

      const safetySettings = [
        {
          category: HarmCategory.HARM_CATEGORY_HARASSMENT,
          threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH,
        },
        {
          category: HarmCategory.HARM_CATEGORY_HATE_SPEECH,
          threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH,
        },
        {
          category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT,
          threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH,
        },
        {
          category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,
          threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH,
        },
      ];

      const zeroShotTemplate = (userPrompt) => {
        return `As a knowledgeable and compassionate medical AI assistant, I'm here to provide helpful information and support. However, please remember that I'm not a substitute for professional medical advice, diagnosis, or treatment. Always consult with a qualified healthcare provider for personalized medical guidance.

        User query: ${userPrompt}

        Response:`;
      };

      async function fileToGenerativePart(file) {
        const base64EncodedDataPromise = new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });

        return {
          inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
        };
      }

      async function sendMessage(prompt, imagePart = null) {
        const formattedPrompt = zeroShotTemplate(prompt);

        let model;
        let result;

        if (imagePart) {
          model = genAI.getGenerativeModel({ model: "gemini-pro-vision", safetySettings });
          result = await model.generateContent([formattedPrompt, imagePart]);
        } else {
          if (!chat) {
            chat = await genAI
              .getGenerativeModel({ model: "gemini-pro", safetySettings })
              .startChat({
                history: [],
                generationConfig: {
                  maxOutputTokens: 4000,
                },
              });
          }
          model = chat;
          result = await model.sendMessage(formattedPrompt);
        }

        try {
          const response = await result.response;
          if (response) {
            const text = await response.text();
            displayMessage(text, "ai");
          } else {
            displayMessage("I apologize, but I couldn't retrieve a safe response. Please try rephrasing your question.", "ai");
          }
        } catch (error) {
          console.error("Error during message generation:", error);
          displayMessage("I encountered an issue while processing your request. Please try again later.", "ai");
        }
      }

      function displayMessage(message, sender) {
        const chatMessages = document.getElementById("chat-messages");
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", sender === "user" ? "user-message" : "ai-message");

        if (sender === "ai") {
          const loadingDiv = document.createElement("div");
          loadingDiv.classList.add("loading-dots");
          loadingDiv.innerHTML = '<div></div><div></div><div></div>';
          messageDiv.appendChild(loadingDiv);
          chatMessages.appendChild(messageDiv);

          setTimeout(() => {
            messageDiv.innerHTML = message;
          }, 1500);
        } else {
          messageDiv.textContent = message;
          chatMessages.appendChild(messageDiv);
        }

        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      document.getElementById("chat-form").addEventListener("submit", function(e) {
        e.preventDefault();
        sendUserMessage();
      });

      async function sendUserMessage() {
        const userInput = document.getElementById("user-input");
        const imageInput = document.getElementById("image-input");
        const message = userInput.value.trim();
        const imageFile = imageInput.files[0];

        if (message || imageFile) {
          let userMessage = message;
          if (imageFile) {
            userMessage += " (Image uploaded)";
          }
          displayMessage(userMessage, "user");

          let imagePart = null;
          if (imageFile) {
            imagePart = await fileToGenerativePart(imageFile);
          }

          await sendMessage(message, imagePart);

          userInput.value = "";
          imageInput.value = "";
          document.getElementById("image-preview").style.display = "none";
        }
      }

      document.getElementById("image-input").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById("image-preview");
            preview.src = e.target.result;
            preview.style.display = "block";
          }
          reader.readAsDataURL(file);
        }
      });
    </script>
  </body>
</html>